{% extends "my_questions/base.html"%}
{% load static %}
{% load my_questions_extras %}

{% block title %}
Тест
{% endblock %}

{% block content %}


<div class="container-fluid">
  <div class="row">
    <div class="col-9">
      <div class="test-output-header">
        <div><h2>{{terms.test}} {{test.name}}</h2></div>
        <div><a href="{% url 'my_questions:edit_test_view' test.id %}">{{terms.edit}}</a> </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-9 test-output-cont" data-test="{{test.id}}">
      {% for q in test_dict %}
      <div class="test-output-q" data-question="{{q.question.0}}">
        <div class="test-output-q-header" >
          <div>
            <h4>{{ question_part_names.question }} {{ forloop.counter }}</h4>
          </div>
          <div>
            <div class="move-controls" style="display:inline-block; margin-left: 10px;">
              <button class="move-up">↑</button>
              <button class="move-down">↓</button>
            </div>
            <a href="{% url 'my_questions:question' q.question.0 %}" target="_blank">{{terms.edit}}</a>
          </div>
        </div>
        {% if q.razdatka.0 != "" %}
          <p>
            <span class="test-output-q-subheader"> {{question_part_names.razdatka}}: </span>
            <br />
            {% for r in q.razdatka %}
              {% if r != "" %}
                <img src="{{r.url}}" class="razdatka">
              {% endif %}
            {% endfor %}
          </p>
        {% endif %}
        <p>
          <span class="test-output-q-subheader"> {{question_part_names.text}}: </span>
          {% for t in q.text %}
            {{t | safe}}
          {% endfor %}
        </p>
        <p>
          <span class="test-output-q-subheader"> {{question_part_names.answer}}: </span>
          {% for t in q.answer %}
            {{t}}
          {% endfor %}
        </p>
        <p>
          <span class="test-output-q-subheader"> {{question_part_names.also_answer}}: </span>
          {% for t in q.also_answer %}
            {{t}}
          {% endfor %}
        </p>
        <p>
          <span class="test-output-q-subheader"> {{question_part_names.not_answer}}: </span>
          {% for t in q.not_answer %}
            {{t}}
          {% endfor %}
        </p>
        <p>
          <span class="test-output-q-subheader"> {{question_part_names.commentary}}: </span>
          {% for t in q.commentary %}
            {{t}}
          {% endfor %}
        </p>
        <p>
          <span class="test-output-q-subheader"> {{question_part_names.sources}}: </span>
          <br />
          {% for t in q.sources %}
            {{t}}
          {% endfor %}
        </p>
        <div class="editors-comments">
          {% for t in q.editor_comments_forms %}
            <form class="comment-form" enctype="multipart/form-data">
              {% csrf_token %}
              <input type="hidden" name="pk" value="{{t.pk.value}}">
              {{ t.editor_comments }}
              {{ t.media }}
              <input type="submit">
            </form>
          {% endfor %}
        </div>
        <form class="rating-form" enctype="multipart/form-data">{% csrf_token %}{{q.rating}}</form>
        <form class="is-answered-form" enctype="multipart/form-data">{% csrf_token %}{{q.is_answered}}</form>
      </div>
      {% endfor %}


    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>




<script>
  $( function() {

      $('.rating-form select[name="rating"]').on('change', function() {
        const form = $(this).closest('form');
        $.ajax({
          url: '{% url "my_questions:save_rating_backend" %}',
          type: 'POST',
          data: form.serialize(),
          dataType: 'json',
          success: function(response) {
            if (response.success) {
              $('#alert').html('<div class="alert alert-success">Thank you for your message!</div>').show();
            } else {
              $('#alert').html('<div class="alert alert-danger">' + response.errors + '</div>').show();
            }
          }
        });
      });

      $('.is-answered-form select[name="is_answered"]').on('change', function() {
        const form = $(this).closest('form');
        $.ajax({
          url: '{% url "my_questions:save_is_answered_backend" %}',
          type: 'POST',
          data: form.serialize(),
          dataType: 'json',
          success: function(response) {
            if (response.success) {
              $('#alert').html('<div class="alert alert-success">Thank you for your message!</div>').show();
            } else {
              $('#alert').html('<div class="alert alert-danger">' + response.errors + '</div>').show();
            }
          }
        });
      });

     $('.comment-form').on('submit', function(event) {
      event.preventDefault();
      $.ajax({
        url: '{% url "my_questions:save_comment_backend" %}',
        type: 'POST',
        data: $(this).serialize(),
        dataType: 'json',
        success: function(response) {
          if (response.success) {
            $('#alert').html('<div class="alert alert-success">Thank you for your message!</div>').show();
          } else {
            $('#alert').html('<div class="alert alert-danger">' + response.errors + '</div>').show();
          }
        }
      });
    });

    // Up-down arrows

    const feedback = $('<div id="feedback" style="margin-top: 10px;"></div>').insertAfter('.test-output-cont');

    function updateButtons($container) {
      const $items = $container.find('.test-output-q');
      $items.find('.move-up, .move-down').prop('disabled', false);
      $items.first().find('.move-up').prop('disabled', true);
      $items.last().find('.move-down').prop('disabled', true);
    }

    function sendOrder($container) {
      const testId = $container.data('test');
      const order = $container.find('.test-output-q').map(function () {
        return $(this).data('question');
      }).get();

      $.post('{% url "my_questions:update_question_order_backend" %}', { "test": testId, "order": order, csrfmiddlewaretoken: '{{ csrf_token }}' })
        .done(() => {
          feedback.text('✅ Order updated successfully!').css('color', 'green').fadeIn().delay(1000).fadeOut();
        })
        .fail(() => {
          feedback.text('❌ Failed to update order.').css('color', 'red').fadeIn().delay(2000).fadeOut();
        });
    }

    $('.test-output-cont').on('click', '.move-up, .move-down', function () {
      const $question = $(this).closest('.test-output-q');
      const $container = $question.closest('.test-output-cont');

      if ($(this).hasClass('move-up')) {
        const $prev = $question.prev('.test-output-q');
        if ($prev.length) {
          $question.slideUp(200, function () {
            $question.insertBefore($prev).slideDown(200);
            updateButtons($container);
            sendOrder($container);
          });
        }
      } else if ($(this).hasClass('move-down')) {
        const $next = $question.next('.test-output-q');
        if ($next.length) {
          $question.slideUp(200, function () {
            $question.insertAfter($next).slideDown(200);
            updateButtons($container);
            sendOrder($container);
          });
        }
      }
    });

    // Initial setup
    $('.test-output-cont').each(function () {
      updateButtons($(this));
    });




  });

</script>
{% endblock %}

{% block bottom_bar %}
    {% include "my_questions/parts/bottom-bar-test-view.html" %}
{% endblock %}