{% extends "my_questions/parts/bottom-bar-wrapper.html"%}
{% load static %}

{% block bottom_bar_contents %}
<div class="container-fluid b-bar-q-list-cont">
  <div class="col-8 test-committed-block">
      {% if test.committed %}
      <p> Этот тест был проведён {{test.committed_datetime}} </p>
      {% else  %}
      <form action="{% url 'my_questions:test_commit_backend' %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.path }}">
        <input type="hidden"  name="test_id" value="{{test.id}}">
        <button type="submit" name="action" value="approve"> Тест был проведён </button>
      </form>
      {% endif %}
    </div>
  <div class="timer">
    <div id="countdown-timer">
      <div id="timer-display">
        <svg width="120" height="120">
          <circle id="base-circle" cx="60" cy="60" r="50" stroke-width="10" fill="none" />
          <circle id="progress-circle" cx="60" cy="60" r="50" stroke="#4caf50" stroke-width="10" fill="none"
                  stroke-dasharray="314" stroke-dashoffset="0" transform="rotate(-90 60 60)" />
        </svg>
        <div id="time-text">00:00</div>
      </div>

      <div id="controls-area">
        <input type="number" id="initial-seconds" value="70" min="0" />
        <div id="controls">
          <button id="start-btn">Start</button>
          <button id="pause-btn">Pause</button>
          <button id="reset-btn">Reset</button>
        </div>
      </div>
    </div>


  </div>
  <audio id="alarm-sound" src="{% static 'my_questions/sounds/beep.mp3' %}" preload="auto"></audio>

 <script>
$(function () {
  let interval = null;
  let remaining = 70;
  let initial = 70;
  let warned = false;
  let alarmed = false;
  let width = $("#timer-display").width();
  let height = $("#timer-display").height();
  $("#timer-display svg")
    .attr("height", height)
    .attr("width", width);
  $("#timer-display svg circle")
    .attr("cy", height/2)
    .attr("cx", width/2)
    .attr("r", height/2 - 5 );

  const circumference = 2 * Math.PI * (width/2 - 5);
  $("#timer-display svg #progress-circle")
    .attr("transform", `rotate(-90 ${width/2} ${height/2})`)
    .attr("stroke-dasharray", circumference);





  const $timeText = $('#time-text');
  const $circle = $('#progress-circle');
  const $input = $('#initial-seconds');
  const alarm = document.getElementById('alarm-sound');


  function updateDisplay() {
    const absRemaining = Math.abs(remaining);
    const minutes = String(Math.floor(absRemaining / 60)).padStart(2, '0');
    const seconds = String(absRemaining % 60).padStart(2, '0');
    $timeText.text((remaining < 0 ? "-" : "") + `${minutes}:${seconds}`);

    let percent = Math.max(0, remaining) / initial;
    let offset = circumference * (1 - percent);
    $circle.css('stroke-dashoffset', offset);

    // Reset classes
    $circle.removeClass('warning negative');

    if (remaining < 0) {
      $circle.addClass('negative');
    } else if (remaining <= 10) {
      $circle.addClass('warning');
    }

    // 10-second warning beep
    if (remaining === 10 && !warned) {
      alarm.play();
      warned = true;
    }

    // 0-second beep
    if (remaining === 0 && !alarmed) {
      alarm.play();
      alarmed = true;
    }
  }

  function startTimer() {
    if (interval) return;
    interval = setInterval(() => {
      remaining--;
      updateDisplay();
    }, 1000);
  }

  function pauseTimer() {
    clearInterval(interval);
    interval = null;
  }

  function resetTimer() {
    pauseTimer();
    const val = parseInt($input.val());
    initial = isNaN(val) || val < 0 ? 0 : val;
    remaining = initial;
    warned = false;
    alarmed = false;
    updateDisplay();
  }

  $('#start-btn').click(startTimer);
  $('#pause-btn').click(pauseTimer);
  $('#reset-btn').click(resetTimer);

  $input.on('input', resetTimer);

  // Initialize
  updateDisplay();
});
</script>


</div>
{% endblock %}
